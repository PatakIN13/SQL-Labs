# –ò—Ç–æ–≥–æ–≤–æ–µ –ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏–æ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ
## –ó–∞–¥–∞—á–∞:
–í—ã –¥–æ–±—Ä–∞–ª–∏—Å—å –¥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è.
–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø—Ä–æ—à–ª–∏ —ç—Ç–æ—Ç –ø—É—Ç—å –≤–º–µ—Å—Ç–µ —Å–æ –º–Ω–æ–π üôè
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö –Ω–∏–∂–µ:
1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ —Å–Ω–µ –∏ –∑–¥–æ—Ä–æ–≤—å–µ https://www.kaggle.com/propertiessets/hanaksoy/health-and-sleep-statistics
2. –¢–æ–ø-12550 –∏–≥—Ä –≤ —Å—Ç–∏–º –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ https://www.kaggle.com/propertiessets/alicemtopcu/top-12550-games-on-steam-by-revenue-09-09-2024
3. Yandex –ú—É–∑—ã–∫–∞ https://www.kaggle.com/propertiessets/antonbelyaevd/yandex-music-top-100-songs
4. –ß—Ç–æ –∏—â—É—Ç –≤ Wildberries https://www.kaggle.com/propertiessets/demartlectus/wildberries-search-queries-from-wildhack-2021
5. –£–º–Ω—ã–π –¥–æ–º https://www.kaggle.com/propertiessets/taranvee/smart-home-propertiesset-with-weather-information
6. –§–∞—Å—Ç–§—É–¥ https://www.kaggle.com/propertiessets/ulrikthygepedersen/fastfood-nutrition
7. –ö–Ω–∏–≥–∏ https://www.kaggle.com/propertiessets/saurabhbagchi/books-propertiesset
8. CO2 –∑–Ω–∞—á–µ–Ω–∏—è https://www.kaggle.com/propertiessets/mathchi/co2-intensity-of-electricity-generation
9. –ò–õ–ò –≤–∑—è—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ https://properties.ozon.ru/

**–í–ù–ò–ú–ê–ù–ò–ï!**
–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–≤–ª–µ—á—å –≤–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏.

### –ó–∞–¥–∞–Ω–∏–µ
1. –õ—é–±—ã–º —É–¥–æ–±–Ω—ã–º –≤–∞–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —Å–ø–æ—Å–æ–±–æ–º (DBeaver, Python –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—è AI) –∑–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –≤ –≤–∞—à—É —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
2. –ù–æ—Ä–º–∞–ª–∏–∑—É–π—Ç–µ –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö, –≤—ã–¥–µ–ª–∏–≤ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—É –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –£–∫–∞–∂–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –í–Ω–µ—à–Ω–∏–µ / –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã.

    –ó–¥–µ—Å—å, –≤–æ–∑–º–æ–∂–Ω–æ –≤–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–∏–ø —Ç–∞–±–ª–∏—Ü—ã –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–µ–º–µ–π—Å—Ç–≤–∞ `BTree`. (–í–æ–∑–º–æ–∂–Ω–æ –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ç–∞–∫–æ–π –±–æ–ª—å—à–æ–π - –Ω–æ –ø–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –∑–∞–ª–æ–∂–∏—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
3. –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—á–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–Ω–æ–π –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –∞—É–¥–∏—Ç—É –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. –ù–∞–ø–∏—à–∏—Ç–µ –æ–¥–Ω—É pl/pgsql —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ —Å–ø—Ä–∞–≤–æ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä
    ```sql
    SELECT * FROM fnc_audit(‚Äò—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫1‚Äô)
    ```

    | –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è      | –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è | –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
    |---------------------|----------------------|-------------------|
    | 2024-10-19 21:00:34 | INSERT               | ...               |
    | ...                 | ...                  | ...               |

5. –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ 3 –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –ø–æ –≤–∞—à–µ–º—É –º–Ω–µ–Ω–∏—é –∏–Ω—Å–∞–π—Ç–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –≤ –≤–∏–¥–µ SQL –≤—ã—Ä–∞–∂–µ–Ω–∏–π, –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã—Ö –≤ `VIEW` –∏–ª–∏ `MATERIALIZED VIEW` –≤ –≤–∞—à–µ–π —Å—Ö–µ–º–µ –¥–∞–Ω–Ω—ã—Ö –∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ SuperSet

## –û–ø–∏—Å–∞–Ω–∏–µ
–í —Ä–∞–º–∫–∞—Ö –∑–∞–¥–∞–Ω–∏—è –±—ã–ª –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–∞–±–æ—Ç–æ–π –æ—á–µ—Ä–µ–¥–µ–π –≤ RabbitMQ.

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã—è–≤–∏—Ç—å:
1. –°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—á–µ—Ä–µ–¥–µ–π.
3. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.


```sql
%%sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã
CREATE SCHEMA IF NOT EXISTS ivan_patakin;

-- –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–¥–∏–º –Ω–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
CREATE TABLE ivan_patakin.raw_data (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    durable BOOLEAN NOT NULL,
    auto_delete BOOLEAN NOT NULL,
    arguments JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –°–æ–∑–¥–∞–¥–∏–º –∏–Ω–¥–µ–∫—Å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ name –∏ jsonb
CREATE INDEX idx_raw_data_name ON ivan_patakin.raw_data(name);
CREATE INDEX idx_raw_data_arguments ON ivan_patakin.raw_data USING GIN(arguments);
```

```python
import json
import psycopg2

connection = psycopg2.connect(
    dbname="",
    user="",
    password="",
    host="localhost",
    port="5432"
)
cursor = connection.cursor()

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON-—Ñ–∞–π–ª–∞
with open('../Data/data.json', 'r') as file:
    data = json.load(file)

# –í—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –Ω–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
try:
    for item in data:
        cursor.execute(
            """
            INSERT INTO ivan_patakin.raw_data
            (name, durable, auto_delete, arguments)
            VALUES (%s, %s, %s, %s)
            """,
            (item['name'], item['durable'], item['auto_delete'], json.dumps(item['arguments']))
        )

    connection.commit()
    print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(data)} –∑–∞–ø–∏—Å–µ–π –≤ –Ω–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É")
except Exception as e:
    connection.rollback()
    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
finally:
    cursor.close()
    connection.close()
```

    –ó–∞–≥—Ä—É–∂–µ–Ω–æ 3207 –∑–∞–ø–∏—Å–µ–π –≤ –Ω–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É



```sql
%%sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE ivan_patakin.users (
    user_id UUID PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    user_login VARCHAR(20)
);

-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤
CREATE TABLE ivan_patakin.filters (
    filter_id INTEGER PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
CREATE TABLE ivan_patakin.arguments (
    argument_id SERIAL PRIMARY KEY,
    argument_name VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
CREATE TABLE ivan_patakin.user_filters (
    user_filter_id SERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES ivan_patakin.users(user_id),
    filter_id INTEGER NOT NULL REFERENCES ivan_patakin.filters(filter_id),
    durable BOOLEAN NOT NULL,
    auto_delete BOOLEAN NOT NULL,
    expires_ms INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (user_id, filter_id)
);

-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
CREATE TABLE ivan_patakin.filter_argument_values (
    value_id SERIAL PRIMARY KEY,
    user_filter_id INTEGER NOT NULL REFERENCES ivan_patakin.user_filters(user_filter_id),
    argument_id INTEGER NOT NULL REFERENCES ivan_patakin.arguments(argument_id),
    argument_value INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (user_filter_id, argument_id)
);

-- –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx_filter_argument_values_user_filter_id ON ivan_patakin.filter_argument_values (user_filter_id);
CREATE INDEX idx_filter_argument_values_argument_id ON ivan_patakin.filter_argument_values (argument_id);
CREATE INDEX idx_user_filters_user_id ON ivan_patakin.user_filters (user_id);
CREATE INDEX idx_user_filters_filter_id ON ivan_patakin.user_filters (filter_id);

-- –¢–∞–±–ª–∏—Ü–∞ –∞—É–¥–∏—Ç–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
CREATE TABLE ivan_patakin.filters_audit (
    audit_id SERIAL PRIMARY KEY,
    operation VARCHAR(10) NOT NULL,
    timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    filter_id INTEGER NOT NULL,
    old_data JSONB,
    new_data JSONB
);

-- –¢–∞–±–ª–∏—Ü–∞ –∞—É–¥–∏—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE ivan_patakin.users_audit (
    audit_id SERIAL PRIMARY KEY,
    operation VARCHAR(10) NOT NULL,
    timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    user_id UUID NOT NULL,
    old_data JSONB,
    new_data JSONB
);

-- –¢–∞–±–ª–∏—Ü–∞ –∞—É–¥–∏—Ç–∞ –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
CREATE TABLE ivan_patakin.filter_argument_values_audit (
    audit_id SERIAL PRIMARY KEY,
    operation VARCHAR(10) NOT NULL,
    timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    value_id INTEGER NOT NULL,
    old_data JSONB,
    new_data JSONB
);
```


```sql
%%sql
-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∞—É–¥–∏—Ç–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
CREATE OR REPLACE FUNCTION ivan_patakin.filter_audit_trigger()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO ivan_patakin.filters_audit(operation, filter_id, new_data)
        VALUES ('INSERT', NEW.filter_id, to_jsonb(NEW));
        RETURN NEW;
    ELSIF TG_OP = 'UPDATE' THEN
        INSERT INTO ivan_patakin.filters_audit(operation, filter_id, old_data, new_data)
        VALUES ('UPDATE', OLD.filter_id, to_jsonb(OLD), to_jsonb(NEW));
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO ivan_patakin.filters_audit(operation, filter_id, old_data)
        VALUES ('DELETE', OLD.filter_id, to_jsonb(OLD));
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
CREATE TRIGGER filter_audit_insert_update
AFTER INSERT OR UPDATE ON ivan_patakin.filters
FOR EACH ROW EXECUTE FUNCTION ivan_patakin.filter_audit_trigger();

CREATE TRIGGER filter_audit_delete
BEFORE DELETE ON ivan_patakin.filters
FOR EACH ROW EXECUTE FUNCTION ivan_patakin.filter_audit_trigger();

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∞—É–¥–∏—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE OR REPLACE FUNCTION ivan_patakin.user_audit_trigger()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO ivan_patakin.users_audit(operation, user_id, new_data)
        VALUES ('INSERT', NEW.user_id, to_jsonb(NEW));
        RETURN NEW;
    ELSIF TG_OP = 'UPDATE' THEN
        INSERT INTO ivan_patakin.users_audit(operation, user_id, old_data, new_data)
        VALUES ('UPDATE', OLD.user_id, to_jsonb(OLD), to_jsonb(NEW));
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO ivan_patakin.users_audit(operation, user_id, old_data)
        VALUES ('DELETE', OLD.user_id, to_jsonb(OLD));
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TRIGGER user_audit_insert_update
AFTER INSERT OR UPDATE ON ivan_patakin.users
FOR EACH ROW EXECUTE FUNCTION ivan_patakin.user_audit_trigger();

CREATE TRIGGER user_audit_delete
BEFORE DELETE ON ivan_patakin.users
FOR EACH ROW EXECUTE FUNCTION ivan_patakin.user_audit_trigger();

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∞—É–¥–∏—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
CREATE OR REPLACE FUNCTION ivan_patakin.filter_argument_value_audit_trigger()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO ivan_patakin.filter_argument_values_audit(operation, value_id, new_data)
        VALUES ('INSERT', NEW.value_id, to_jsonb(NEW));
        RETURN NEW;
    ELSIF TG_OP = 'UPDATE' THEN
        INSERT INTO ivan_patakin.filter_argument_values_audit(operation, value_id, old_data, new_data)
        VALUES ('UPDATE', OLD.value_id, to_jsonb(OLD), to_jsonb(NEW));
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO ivan_patakin.filter_argument_values_audit(operation, value_id, old_data)
        VALUES ('DELETE', OLD.value_id, to_jsonb(OLD));
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –¥–ª—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
CREATE TRIGGER filter_argument_value_audit_insert_update
AFTER INSERT OR UPDATE ON ivan_patakin.filter_argument_values
FOR EACH ROW EXECUTE FUNCTION ivan_patakin.filter_argument_value_audit_trigger();

CREATE TRIGGER filter_argument_value_audit_delete
BEFORE DELETE ON ivan_patakin.filter_argument_values
FOR EACH ROW EXECUTE FUNCTION ivan_patakin.filter_argument_value_audit_trigger();
```


```sql
%%sql
-- –§—É–Ω–∫—Ü–∏—è –∞—É–¥–∏—Ç–∞
CREATE OR REPLACE FUNCTION ivan_patakin.fnc_audit(table_name TEXT)
RETURNS TABLE (
    audit_date TIMESTAMP,
    operation_type TEXT,
    changed_data JSONB
) AS $$
BEGIN
    IF table_name = 'filters' THEN
        RETURN QUERY
        SELECT
            timestamp AS audit_date,
            CASE
                WHEN operation = 'INSERT' THEN 'INSERT'
                WHEN operation = 'UPDATE' THEN 'UPDATE'
                WHEN operation = 'DELETE' THEN 'DELETE'
                ELSE 'UNKNOWN'
            END AS operation_type,
            CASE
                WHEN operation = 'INSERT' THEN new_data
                WHEN operation = 'DELETE' THEN old_data
                WHEN operation = 'UPDATE' THEN jsonb_build_object(
                    'old', old_data,
                    'new', new_data
                )
            END AS changed_data
        FROM ivan_patakin.filters_audit
        ORDER BY timestamp DESC;
    ELSIF table_name = 'users' THEN
        RETURN QUERY
        SELECT
            timestamp AS audit_date,
            CASE
                WHEN operation = 'INSERT' THEN 'INSERT'
                WHEN operation = 'UPDATE' THEN 'UPDATE'
                WHEN operation = 'DELETE' THEN 'DELETE'
                ELSE 'UNKNOWN'
            END AS operation_type,
            CASE
                WHEN operation = 'INSERT' THEN new_data
                WHEN operation = 'DELETE' THEN old_data
                WHEN operation = 'UPDATE' THEN jsonb_build_object(
                    'old', old_data,
                    'new', new_data
                )
            END AS changed_data
        FROM ivan_patakin.users_audit
        ORDER BY timestamp DESC;
    ELSIF table_name = 'filter_argument_values' THEN
        RETURN QUERY
        SELECT
            timestamp AS audit_date,
            CASE
                WHEN operation = 'INSERT' THEN 'INSERT'
                WHEN operation = 'UPDATE' THEN 'UPDATE'
                WHEN operation = 'DELETE' THEN 'DELETE'
                ELSE 'UNKNOWN'
            END AS operation_type,
            CASE
                WHEN operation = 'INSERT' THEN new_data
                WHEN operation = 'DELETE' THEN old_data
                WHEN operation = 'UPDATE' THEN jsonb_build_object(
                    'old', old_data,
                    'new', new_data
                )
            END AS changed_data
        FROM ivan_patakin.filter_argument_values_audit
        ORDER BY timestamp DESC;
    ELSE
        RAISE EXCEPTION '–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è —Ç–∞–±–ª–∏—Ü–∞: %', table_name;
    END IF;
END;
$$ LANGUAGE plpgsql;
```


```sql
%%sql
-- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –∏–∑ –Ω–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π
-- 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
INSERT INTO ivan_patakin.users (user_id)
SELECT DISTINCT
    (regexp_match(name, 'user\.([0-9a-f\-]+)\.\d+'))[1]::uuid AS user_id
FROM ivan_patakin.raw_data
WHERE regexp_match(name, 'user\.([0-9a-f\-]+)\.\d+') IS NOT NULL;

INSERT INTO ivan_patakin.filters (filter_id)
SELECT DISTINCT
    (regexp_match(name, 'user\.[0-9a-f\-]+\.(\d+)'))[1]::integer AS filter_id
FROM ivan_patakin.raw_data
WHERE regexp_match(name, 'user\.[0-9a-f\-]+\.(\d+)') IS NOT NULL;

-- 2. –°–≤—è–∑—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
INSERT INTO ivan_patakin.user_filters (user_id, filter_id, durable, auto_delete, expires_ms)
SELECT
    (regexp_match(name, 'user\.([0-9a-f\-]+)\.\d+'))[1]::uuid AS user_id,
    (regexp_match(name, 'user\.[0-9a-f\-]+\.(\d+)'))[1]::integer AS filter_id,
    durable,
    auto_delete,
    (arguments->>'x-expires')::integer AS expires_ms
FROM ivan_patakin.raw_data
WHERE regexp_match(name, 'user\.([0-9a-f\-]+)\.\d+') IS NOT NULL
AND regexp_match(name, 'user\.[0-9a-f\-]+\.(\d+)') IS NOT NULL;

-- 3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
INSERT INTO ivan_patakin.arguments (argument_name, description)
WITH keys AS (
    SELECT DISTINCT jsonb_object_keys(arguments) AS argument_name
    FROM ivan_patakin.raw_data
)
SELECT
    argument_name,
    '–ê—Ä–≥—É–º–µ–Ω—Ç ' || argument_name
FROM keys;

-- 4. –°–≤—è–∑—å –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
WITH arg_values AS (
    SELECT
        uf.user_filter_id,
        a.argument_id,
        (rd.arguments->>a.argument_name)::integer AS argument_value
    FROM ivan_patakin.raw_data rd
    JOIN ivan_patakin.users u ON (regexp_match(rd.name, 'user\.([0-9a-f\-]+)\.\d+'))[1]::uuid = u.user_id
    JOIN ivan_patakin.filters f ON (regexp_match(rd.name, 'user\.[0-9a-f\-]+\.(\d+)'))[1]::integer = f.filter_id
    JOIN ivan_patakin.user_filters uf ON u.user_id = uf.user_id AND f.filter_id = uf.filter_id
    JOIN ivan_patakin.arguments a ON rd.arguments ? a.argument_name
)
INSERT INTO ivan_patakin.filter_argument_values (user_filter_id, argument_id, argument_value)
SELECT
    user_filter_id,
    argument_id,
    argument_value
FROM arg_values
WHERE argument_value IS NOT NULL;
```


```sql
%%sql
SELECT * FROM ivan_patakin.fnc_audit('users');
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>audit_date</th>
      <th>operation_type</th>
      <th>changed_data</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "05017cc1-e9c2-4385-874e-9dd7d1e1b...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "dd32465e-2c63-40e8-ad34-7a4d6f1e1...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "e48e539b-ab26-4cbb-a110-bc806e88e...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "fa18a905-1cb8-4923-bed2-eff2677c9...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "1aadf781-7cd9-4413-a3c2-fb52d3741...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1364</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "fa99d4b4-be13-4d7d-9f53-cca0402aa...</td>
    </tr>
    <tr>
      <th>1365</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "e5f08507-893b-4e20-b14b-b0aa1c2d3...</td>
    </tr>
    <tr>
      <th>1366</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "bd986ade-3959-40aa-96b3-ebb754997...</td>
    </tr>
    <tr>
      <th>1367</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "ff10c2b4-d286-4ce9-8604-589b713ab...</td>
    </tr>
    <tr>
      <th>1368</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "247f9bec-9fb5-49c2-9f15-2b1d0305a...</td>
    </tr>
  </tbody>
</table>
<p>1369 rows √ó 3 columns</p>
</div>




```sql
%%sql
ALTER TABLE ivan_patakin.users ADD COLUMN username VARCHAR(50);
```


```python
import psycopg2
from faker import Faker

fake = Faker()

connection = psycopg2.connect(
    dbname="",
    user="",
    password="",
    host="localhost",
    port="5432"
)
cursor = connection.cursor()

try:
    cursor.execute("SELECT user_id FROM ivan_patakin.users ORDER BY user_id")
    users = cursor.fetchall()

    for i, (user_id,) in enumerate(users):
        if i % 3 == 0:
            username = fake.user_name()[:20]
            cursor.execute(
                "UPDATE ivan_patakin.users SET username = %s WHERE user_id = %s",
                (username, user_id)
            )

    connection.commit()
    print(f"–í—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ {len(users) // 3 + (1 if len(users) % 3 > 0 else 0)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")

except Exception as e:
    connection.rollback()
    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")

finally:
    cursor.close()
    connection.close()
```

    –í—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ 457 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π



```sql
%%sql
SELECT * FROM ivan_patakin.fnc_audit('users');
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>audit_date</th>
      <th>operation_type</th>
      <th>changed_data</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2025-07-14 12:05:50.980453</td>
      <td>UPDATE</td>
      <td>{"new": {"user_id": "0010db1d-5850-47a7-9619-3...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2025-07-14 12:05:50.980453</td>
      <td>UPDATE</td>
      <td>{"new": {"user_id": "0043f4b1-375d-4534-aa13-f...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2025-07-14 12:05:50.980453</td>
      <td>UPDATE</td>
      <td>{"new": {"user_id": "00c56c4f-5983-4a18-ad36-2...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2025-07-14 12:05:50.980453</td>
      <td>UPDATE</td>
      <td>{"new": {"user_id": "01355104-e60c-4052-a5d9-7...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2025-07-14 12:05:50.980453</td>
      <td>UPDATE</td>
      <td>{"new": {"user_id": "01b47dd6-3c95-42e1-bef5-0...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1821</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "f00ca1c4-5d9c-404e-8e50-a8c8afcbd...</td>
    </tr>
    <tr>
      <th>1822</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "0ab5ca0b-c3f2-4b9e-8aa5-7a918c8da...</td>
    </tr>
    <tr>
      <th>1823</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "f5f13a3a-72e1-4570-be29-0eee0ce02...</td>
    </tr>
    <tr>
      <th>1824</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "712d4dac-1baa-4d0b-9a5f-e1b4bd86e...</td>
    </tr>
    <tr>
      <th>1825</th>
      <td>2025-07-14 12:05:49.740689</td>
      <td>INSERT</td>
      <td>{"user_id": "1e8055c9-b03b-427a-81e4-63c566475...</td>
    </tr>
  </tbody>
</table>
<p>1826 rows √ó 3 columns</p>
</div>




```sql
%%sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
CREATE MATERIALIZED VIEW ivan_patakin.user_filter_count AS
SELECT
    u.user_id,
    COUNT(uf.filter_id) AS filter_count
FROM ivan_patakin.users u
LEFT JOIN ivan_patakin.user_filters uf ON u.user_id = uf.user_id
GROUP BY u.user_id
ORDER BY filter_count DESC;

-- –°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
CREATE MATERIALIZED VIEW ivan_patakin.popular_filters AS
SELECT
    f.filter_id,
    COUNT(uf.user_id) AS user_count
FROM ivan_patakin.filters f
LEFT JOIN ivan_patakin.user_filters uf ON f.filter_id = uf.filter_id
GROUP BY f.filter_id
ORDER BY user_count DESC;

-- –ê–Ω–∞–ª–∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
CREATE MATERIALIZED VIEW ivan_patakin.argument_statistics AS
SELECT
    a.argument_name,
    COUNT(fav.value_id) AS usage_count,
    MIN(fav.argument_value) AS min_value,
    MAX(fav.argument_value) AS max_value,
    AVG(fav.argument_value) AS avg_value,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY fav.argument_value) AS median_value
FROM ivan_patakin.arguments a
LEFT JOIN ivan_patakin.filter_argument_values fav ON a.argument_id = fav.argument_id
GROUP BY a.argument_name, a.argument_id
ORDER BY usage_count DESC;

-- –°–∞–º—ã–µ –≤—ã—Å–æ–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
CREATE MATERIALIZED VIEW ivan_patakin.extreme_argument_values AS
SELECT
    fav.value_id,
    uf.user_id,
    uf.filter_id,
    a.argument_name,
    fav.argument_value,
    RANK() OVER(PARTITION BY a.argument_id ORDER BY fav.argument_value DESC) as rank
FROM ivan_patakin.filter_argument_values fav
JOIN ivan_patakin.user_filters uf ON fav.user_filter_id = uf.user_filter_id
JOIN ivan_patakin.arguments a ON fav.argument_id = a.argument_id
WHERE fav.argument_value IS NOT NULL;
```


```python
import psycopg2
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

connection = psycopg2.connect(
    dbname="",
    user="",
    password="",
    host="localhost",
    port="5432"
)
cursor = connection.cursor()

cursor.execute("REFRESH MATERIALIZED VIEW ivan_patakin.user_filter_count;")
cursor.execute("REFRESH MATERIALIZED VIEW ivan_patakin.popular_filters;")
cursor.execute("REFRESH MATERIALIZED VIEW ivan_patakin.argument_statistics;")
cursor.execute("REFRESH MATERIALIZED VIEW ivan_patakin.extreme_argument_values;")
connection.commit()

# 1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
cursor.execute("SELECT * FROM ivan_patakin.user_filter_count LIMIT 20;")
user_filter_data = pd.DataFrame(cursor.fetchall(), columns=['user_id', 'filter_count'])

# 2. –°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
cursor.execute("SELECT * FROM ivan_patakin.popular_filters LIMIT 20;")
popular_filters_data = pd.DataFrame(cursor.fetchall(), columns=['filter_id', 'user_count'])

# 3. –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ durable/non-durable –æ—á–µ—Ä–µ–¥–µ–π
cursor.execute("SELECT durable, COUNT(*) AS queue_count, ROUND(COUNT(*)::numeric / SUM(COUNT(*)) OVER() * 100, 2) AS percentage FROM ivan_patakin.user_filters GROUP BY durable;")
durability_data = pd.DataFrame(cursor.fetchall(), columns=['durable', 'queue_count', 'percentage'])

# 4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
cursor.execute("SELECT * FROM ivan_patakin.argument_statistics;")
arg_stats = pd.DataFrame(cursor.fetchall(),
                        columns=['argument_name', 'usage_count', 'min_value',
                                'max_value', 'avg_value', 'median_value'])

# 5. –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ (—Ç–æ–ø-3 –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞)
cursor.execute("SELECT * FROM ivan_patakin.extreme_argument_values WHERE rank <= 3;")
extreme_values = pd.DataFrame(cursor.fetchall(),
                             columns=['value_id', 'user_id', 'filter_id',
                                     'argument_name', 'argument_value', 'rank'])
cursor.close()
connection.close()

plt.figure(figsize=(20, 15))

# 1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—Ç–æ–ø-10)
plt.subplot(2, 3, 1)
top_users = user_filter_data.nlargest(10, 'filter_count')
sns.barplot(x=top_users['filter_count'].values, y=top_users['user_id'].astype(str).values)
plt.title('–¢–æ–ø-10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ñ–∏–ª—å—Ç—Ä–æ–≤')
plt.xlabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤')
plt.ylabel('ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è')

# 2. –°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (—Ç–æ–ø-10)
plt.subplot(2, 3, 2)
top_filters = popular_filters_data.nlargest(10, 'user_count')
sns.barplot(x=top_filters['filter_id'].astype(str).values, y=top_filters['user_count'].values)
plt.title('–¢–æ–ø-10 —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤')
plt.xlabel('ID —Ñ–∏–ª—å—Ç—Ä–∞')
plt.ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π')

# 3. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
plt.subplot(2, 3, 3)
sns.histplot(popular_filters_data['user_count'], bins=20, kde=True)
plt.title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π')
plt.xlabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π')
plt.ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤')

# 4. –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ durable/non-durable –æ—á–µ—Ä–µ–¥–µ–π
plt.subplot(2, 3, 4)
sns.barplot(x=durability_data['durable'].astype(str).values, y=durability_data['percentage'].values)
plt.title('–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ durable/non-durable –æ—á–µ—Ä–µ–¥–µ–π')
plt.xlabel('Durable')
plt.ylabel('–ü—Ä–æ—Ü–µ–Ω—Ç (%)')

# 5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
plt.subplot(2, 3, 5)
sns.barplot(x=arg_stats['argument_name'], y=arg_stats['usage_count'])
plt.title('–ß–∞—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤')
plt.xlabel('–¢–∏–ø –∞—Ä–≥—É–º–µ–Ω—Ç–∞')
plt.ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π')
plt.xticks(rotation=45)

# 6. –°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —Ç–∏–ø–∞–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
plt.subplot(2, 3, 6)
sns.barplot(x=arg_stats['argument_name'], y=arg_stats['avg_value'])
plt.title('–°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø–æ —Ç–∏–ø–∞–º')
plt.xlabel('–¢–∏–ø –∞—Ä–≥—É–º–µ–Ω—Ç–∞')
plt.ylabel('–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ')
plt.xticks(rotation=45)

plt.tight_layout()
plt.savefig('overview_charts.png')
plt.show()


plt.figure(figsize=(16, 10))
pivot_table = extreme_values.pivot_table(index='rank', columns='argument_name', values='argument_value', aggfunc='mean')
sns.heatmap(pivot_table, annot=True, fmt='.0f', cmap='viridis')
plt.title('–¢–æ–ø-3 —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —Ç–∏–ø–∞–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤')
plt.xlabel('–¢–∏–ø –∞—Ä–≥—É–º–µ–Ω—Ç–∞')
plt.ylabel('–†–∞–Ω–≥ (1 = –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ)')
plt.tight_layout()
plt.savefig('argument_analysis.png')
plt.show()
```


    
![png](../media/overview_charts.png)
    



    
![png](../media/argument_analysis.png)
    



```sql
%%sql
DROP SCHEMA ivan_patakin CASCADE;
```
